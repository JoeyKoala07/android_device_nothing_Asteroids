name: Device tree checks

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install linters
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt yamllint dos2unix

      - name: Validate YAML in repo (basic)
        run: |
          yamllint -s . || (echo "::error title=YAML lint failed::Fix YAML warnings/errors"; exit 1)

      - name: Find candidate shell scripts
        id: list_scripts
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t SCRIPTS < <(git ls-files | grep -E '\.sh$|/vendorsetup\.sh$|/extract-files$' || true)
          if ((${#SCRIPTS[@]}==0)); then
            echo "scripts=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          {
            echo 'scripts<<EOF'
            printf '%s\n' "${SCRIPTS[@]}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: CRLF guard (no Windows line endings)
        if: steps.list_scripts.outputs.scripts != ''
        shell: bash
        run: |
          bad=0
          while read -r f; do
            if file "$f" | grep -q 'CRLF'; then
              echo "::error file=$f,title=CRLF detected::Convert to LF (run: dos2unix $f)"
              bad=1
            fi
          done <<< "${{ steps.list_scripts.outputs.scripts }}"
          exit $bad

      - name: Bash syntax check
        if: steps.list_scripts.outputs.scripts != ''
        shell: bash
        run: |
          fail=0
          while read -r f; do
            echo "bash -n $f"
            if ! bash -n "$f"; then fail=1; fi
          done <<< "${{ steps.list_scripts.outputs.scripts }}"
          exit $fail

      - name: shellcheck (static analysis)
        if: steps.list_scripts.outputs.scripts != ''
        run: |
          shellcheck -x ${{ steps.list_scripts.outputs.scripts }}

      - name: shfmt (format check)
        if: steps.list_scripts.outputs.scripts != ''
        run: |
          if ! shfmt -l -d ${{ steps.list_scripts.outputs.scripts }}; then
            echo "::error title=shfmt formatting drift::Run: shfmt -w <file>"
            exit 1
          fi

      - name: Verify recovery.fstab exists in-tree
        shell: bash
        run: |
          FSTAB="recovery/root/system/etc/recovery.fstab"
          if [[ ! -f "$FSTAB" ]]; then
            echo "::error file=$FSTAB,title=recovery.fstab missing::Add a real recovery.fstab file at this path."
            exit 1
          fi

      - name: Quick sanity: required files exist
        shell: bash
        run: |
          for f in BoardConfig.mk AndroidProducts.mk device.mk Android.mk; do
            [[ -f "$f" ]] || { echo "::error file=$f,title=Missing file::Create this file"; exit 1; }
          done

      - name: Show summary
        run: echo "âœ… Device tree checks passed."
